name: Build BetterPushback Plugin

on:
  push:
    branches:
      - 'main'

permissions:
  contents: read

jobs:
  build-linux-windows:
    name: Build Linux & Windows
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout BetterPusbackMod
        uses: actions/checkout@v4
        with:
          path: BetterPusbackMod
          fetch-depth: 0

      - name: Checkout libacfutils
        uses: actions/checkout@v4
        with:
          repository: olivierbutler/libacfutils
          path: libacfutils

      - name: Cache libacfutils build
        id: cache-libacfutils-linux
        uses: actions/cache@v4
        with:
          path: |
            libacfutils/qmake/lin64
            libacfutils/qmake/win64
            libacfutils/glew
            libacfutils/openal-soft
            libacfutils/cairo
            libacfutils/freetype
            libacfutils/pcre2
            libacfutils/cglm
            libacfutils/libpng
            libacfutils/libxml2
            libacfutils/opus
            libacfutils/ssl
            libacfutils/libiconv
            libacfutils/curl
            libacfutils/zlib
            libacfutils/lzma
            libacfutils/SDK
          key: libacfutils-linux-win-${{ hashFiles('libacfutils/**/*.pro', 'libacfutils/build_deps') }}
          restore-keys: |
            libacfutils-linux-win-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            zip \
            gettext \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            qt5-qmake \
            qtbase5-dev \
            qtbase5-dev-tools \
            qtchooser \
            mingw-w64 \
            mingw-w64-x86-64-dev \
            gcc-mingw-w64-x86-64 \
            g++-mingw-w64-x86-64 \
            libz-mingw-w64-dev \
            pkg-config \
            libasound2-dev \
            portaudio19-dev \
            libpulse-dev \
            libsoundio-dev \
            libx11-dev \
            libxcursor-dev \
            automake \
            autoconf \
            libtool \
            unzip

      - name: Build libacfutils dependencies
        if: steps.cache-libacfutils-linux.outputs.cache-hit != 'true'
        working-directory: libacfutils
        run: |
          set -e
          chmod +x build_deps
          # Patch build_deps to fix CMake compatibility for openal-soft
          # The script extracts to openal-soft-<version>, so we patch after extraction
          sed -i 's|cmake -DCMAKE_INSTALL_PREFIX|cmake -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_INSTALL_PREFIX|g' build_deps
          ./build_deps

      - name: Build libacfutils library
        if: steps.cache-libacfutils-linux.outputs.cache-hit != 'true'
        working-directory: libacfutils/qmake
        run: |
          chmod +x build-win-lin
          ./build-win-lin

      - name: Build for Linux
        working-directory: BetterPusbackMod
        run: |
          cd src
          rm -rf CMakeCache.txt CMakeFiles/ cmake_install.cmake Makefile
          cmake -DCMAKE_BUILD_TYPE=Release .
          make -j$(nproc)

      - name: Build for Windows (cross-compile)
        working-directory: BetterPusbackMod
        run: |
          cd src
          rm -rf CMakeCache.txt CMakeFiles/ cmake_install.cmake Makefile
          cmake -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=XCompile.cmake \
            -DHOST=x86_64-w64-mingw32 .
          make -j$(nproc)
          rm -f libBetterPushback.xpl.dll.a || true

      - name: Strip binaries
        working-directory: BetterPusbackMod
        run: |
          strip win_x64/BetterPushback.xpl || true
          strip lin_x64/BetterPushback.xpl || true

      - name: Create release package structure
        working-directory: BetterPusbackMod
        run: |
          mkdir -p BetterPushback/lin_x64
          mkdir -p BetterPushback/win_x64
          
          # Copy xpl files
          cp lin_x64/BetterPushback.xpl BetterPushback/lin_x64/
          cp win_x64/BetterPushback.xpl BetterPushback/win_x64/
          
          # Copy config files
          cp BetterPushback_doors.cfg BetterPushback/
          cp plg_exclude.cfg BetterPushback/
          cp COPYING BetterPushback/
          
          # Copy data files
          mkdir -p BetterPushback/data/msgs
          cp data/msgs/README.txt BetterPushback/data/msgs/ || true
          cp data/msgs/cc_aliases.cfg BetterPushback/data/msgs/ || true
          find data/msgs -type f -iname '*.opus' -exec cp --parents {} BetterPushback/ \;
          
          # Copy po files
          mkdir -p BetterPushback/data/po
          find data/po -iname '*.po' -exec cp --parents {} BetterPushback/ \;
          
          # Copy icon files
          for DIR in data/icons/*/; do
            mkdir -p "BetterPushback/$DIR"
            for FILE in accept_plan.png conn_first.png delete_seg.png place_seg.png cancel_plan.png move_view.png rotate_seg.png disconnect.png reconnect.png; do
              cp "$DIR$FILE" "BetterPushback/$DIR" 2>/dev/null || true
            done
          done
          cp data/icons/en/planner.png BetterPushback/data/icons/en/ || true
          cp data/icons/en/push-back.png BetterPushback/data/icons/en/ || true
          cp data/icons/en/conn_first_mb.png BetterPushback/data/icons/en/ || true
          cp data/icons/en/status.png BetterPushback/data/icons/en/ || true
          
          # Copy font files
          mkdir -p BetterPushback/data/fonts
          find data/fonts -iname '*.otf' -o -iname '*.ttf' | while read f; do
            cp --parents "$f" BetterPushback/
          done
          
          # Copy objects
          mkdir -p BetterPushback/objects/tugs
          cp objects/night_lamp.obj BetterPushback/objects/
          cp objects/tugs/LIVERIES_HOWTO.txt BetterPushback/objects/tugs/ || true
          cp objects/tugs/readme.txt BetterPushback/objects/tugs/ || true
          
          # Copy tug files
          find objects/tugs/*.tug -type f \( -iname '*.obj' -o -iname '*.cfg' -o -iname '*.wav' -o -iname '*.opus' -o -iname '*.png' \) | while read f; do
            cp --parents "$f" BetterPushback/
          done
          
          # Copy override files
          mkdir -p BetterPushback/objects/override
          find objects/override -iname '*.acf' -exec cp --parents {} BetterPushback/ \;

      - name: Upload Linux & Windows release package
        uses: actions/upload-artifact@v4
        with:
          name: BetterPushback-Linux-Windows
          path: BetterPusbackMod/BetterPushback/

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout BetterPusbackMod
        uses: actions/checkout@v4
        with:
          path: BetterPusbackMod
          fetch-depth: 0

      - name: Checkout libacfutils
        uses: actions/checkout@v4
        with:
          repository: olivierbutler/libacfutils
          path: libacfutils

      - name: Cache libacfutils build
        id: cache-libacfutils-macos
        uses: actions/cache@v4
        with:
          path: |
            libacfutils/qmake/mac64
            libacfutils/glew
            libacfutils/openal-soft
            libacfutils/cairo
            libacfutils/freetype
            libacfutils/pcre2
            libacfutils/cglm
            libacfutils/libpng
            libacfutils/libxml2
            libacfutils/opus
            libacfutils/ssl
            libacfutils/libiconv
            libacfutils/curl
            libacfutils/zlib
            libacfutils/lzma
            libacfutils/SDK
          key: libacfutils-macos-${{ hashFiles('libacfutils/**/*.pro', 'libacfutils/build_deps') }}
          restore-keys: |
            libacfutils-macos-

      - name: Install build dependencies
        run: |
          brew install cmake automake autoconf libtool qt@5
          echo 'export PATH="/opt/homebrew/opt/qt@5/bin:$PATH"' >> ~/.bash_profile
          export PATH="/opt/homebrew/opt/qt@5/bin:$PATH"

      - name: Build libacfutils dependencies
        if: steps.cache-libacfutils-macos.outputs.cache-hit != 'true'
        working-directory: libacfutils
        run: |
          set -e
          chmod +x build_deps
          # Patch build_deps to fix CMake compatibility for openal-soft
          # The script extracts to openal-soft-<version>, so we patch after extraction
          sed -i '' 's|cmake -DCMAKE_INSTALL_PREFIX|cmake -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_INSTALL_PREFIX|g' build_deps
          ./build_deps

      - name: Build libacfutils library
        if: steps.cache-libacfutils-macos.outputs.cache-hit != 'true'
        working-directory: libacfutils/qmake
        run: |
          export PATH="/opt/homebrew/opt/qt@5/bin:/usr/local/opt/qt@5/bin:$PATH"
          chmod +x build-mac
          ./build-mac

      - name: Build for macOS
        working-directory: BetterPusbackMod
        run: |
          cd src
          rm -rf CMakeCache.txt CMakeFiles/ cmake_install.cmake Makefile
          cmake -DCMAKE_BUILD_TYPE=Release .
          make -j$(sysctl -n hw.ncpu)

      - name: Strip binary
        working-directory: BetterPusbackMod
        run: |
          strip -x mac_x64/BetterPushback.xpl || true

      - name: Upload macOS binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: BetterPushback-macOS-binary
          path: BetterPusbackMod/mac_x64/

  package-release:
    name: Package Release
    needs: [build-linux-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout BetterPusbackMod
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux & Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: BetterPushback-Linux-Windows
          path: BetterPushback/

      - name: Download macOS binary artifact
        uses: actions/download-artifact@v4
        with:
          name: BetterPushback-macOS-binary
          path: BetterPushback/mac_x64/

      - name: Create release zip
        run: |
          zip -r BetterPushback.zip BetterPushback/

      - name: Upload complete release package
        uses: actions/upload-artifact@v4
        with:
          name: BetterPushback-Complete
          path: BetterPushback.zip
